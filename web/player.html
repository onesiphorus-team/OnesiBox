<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OnesiBox Player</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; background: #000; overflow: hidden; }
    .container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    video { width: 100%; height: 100%; object-fit: contain; background: #000; }
    .loading, .error { color: #fff; font-family: sans-serif; font-size: 24px; text-align: center; }
    .error { color: #ff6b6b; }
    .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="loading"><div class="spinner"></div><div>Caricamento...</div></div>
  </div>

  <script>
    const LANG_MAP = {
      'it': 'I', 'en': 'E', 'es': 'S', 'pt': 'T', 'fr': 'F',
      'de': 'X', 'ru': 'U', 'ja': 'J', 'ko': 'KO', 'zh': 'CHS'
    };

    function parseJwUrl(url) {
      const hashMatch = url.match(/#([a-z]{2,3})\/mediaitems\/[^\/]+\/([^\/?]+)/i);
      if (hashMatch) return { lang: hashMatch[1].toLowerCase(), mediaId: hashMatch[2] };
      const pathMatch = url.match(/\/([a-z]{2,3})\/.*\/([a-zA-Z0-9_-]+_VIDEO)/i);
      if (pathMatch) return { lang: pathMatch[1].toLowerCase(), mediaId: pathMatch[2] };
      return null;
    }

    async function fetchMediaData(lang, mediaId) {
      const apiLang = LANG_MAP[lang] || lang.toUpperCase();
      const response = await fetch(`/api/jw-media?lang=${apiLang}&mediaId=${encodeURIComponent(mediaId)}`);
      if (!response.ok) throw new Error('Media non trovato');
      const data = await response.json();
      if (!data.media || !data.media[0]) throw new Error('Nessun media');
      return data.media[0];
    }

    function getBestVideoUrl(media) {
      const videos = (media.files || []).filter(f => f.progressiveDownloadURL);
      if (!videos.length) throw new Error('Nessun video disponibile');
      videos.sort((a, b) => (parseInt(b.label) || 0) - (parseInt(a.label) || 0));
      return videos[0].progressiveDownloadURL;
    }

    function showError(msg) {
      const container = document.getElementById('container');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = msg;
      container.innerHTML = '';
      container.appendChild(errorDiv);
      // Fallback: if backend polling doesn't consume the error flag within 60s,
      // navigate to standby to self-heal
      setTimeout(() => {
        if (window.__onesiboxVideoError) window.location.href = '/';
      }, 60000);
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      const url = params.get('url');

      if (!url) { showError('Nessun URL'); return; }

      const parsed = parseJwUrl(url);
      if (!parsed) {
        // Direct video URL
        if (url.match(/\.(mp4|webm)(\?|$)/i)) {
          playVideo(url);
        } else {
          showError('URL non supportato');
        }
        return;
      }

      try {
        const media = await fetchMediaData(parsed.lang, parsed.mediaId);
        const videoUrl = getBestVideoUrl(media);
        console.log('Video URL:', videoUrl);
        playVideo(videoUrl);
      } catch (err) {
        console.error(err);
        showError('Errore: ' + err.message);
      }
    }

    function playVideo(videoUrl) {
      const container = document.getElementById('container');
      container.innerHTML = '';

      const video = document.createElement('video');
      video.id = 'player';
      video.autoplay = true;
      video.controls = true;
      video.style.cssText = 'width:100%;height:100%';

      const source = document.createElement('source');
      source.src = videoUrl;
      source.type = 'video/mp4';

      video.appendChild(source);
      container.appendChild(video);

      video.onended = () => { window.__onesiboxVideoEnded = true; };

      video.onerror = (e) => {
        console.error('Video error:', video.error);
        window.__onesiboxVideoError = true;
        showError('Errore video: ' + (video.error ? video.error.code : 'sconosciuto'));
      };

      // Try fullscreen
      video.onplay = () => {
        video.requestFullscreen && video.requestFullscreen().catch(() => {});
      };
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
